version: "3.2"

services:
  postgres:
    image: postgres:10.0
    volumes:
    - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: aleph
      POSTGRES_PASSWORD: aleph
      POSTGRES_DATABASE: aleph

  elasticsearch:
    image: malteos/aleph-elasticsearch:${ALEPH_TAG:-3.9.0}
    hostname: elasticsearch
    environment:
    - discovery.type=single-node
    volumes:
    - elasticsearch-data:/usr/share/elasticsearch/data

  redis:
    image: redis:alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
    - redis-data:/data

  convert-document:
    image: alephdata/convert-document:58d74ecccb4ce475668a7d72c3b4432044dcd14d
    read_only: true
    restart: on-failure
    tmpfs: /tmp

  ingest-file:
    image: malteos/ingest-file:${ALEPH_TAG:-3.9.0}
    tmpfs:
    - /tmp:mode=777
    volumes:
    - archive-data:/data
    depends_on:
    - postgres
    - redis
    - convert-document
    restart: on-failure
    env_file:
    - ../aleph.env

  worker:
    image: malteos/aleph:${ALEPH_TAG:-3.9.0}
    command: aleph worker
    restart: on-failure
    depends_on:
    - postgres
    - elasticsearch
    - redis
    - ingest-file
    tmpfs:
    - /tmp
    volumes:
    - archive-data:/data
    env_file:
    - ../aleph.env

  shell:
    image: malteos/aleph:${ALEPH_TAG:-3.9.0}
    command: /bin/bash
    depends_on:
    - postgres
    - elasticsearch
    - redis
    - ingest-file
    - worker
    tmpfs:
    - /tmp
    volumes:
    - archive-data:/data
    - "./mappings:/aleph/mappings"
    - "/:/host"
    env_file:
    - ../aleph.env

  api:
    image: malteos/aleph:${ALEPH_TAG:-3.9.0}
    command: gunicorn -w 6 -b 0.0.0.0:8000 --log-level debug --log-file - aleph.wsgi:app
    expose:
    - 8000
    depends_on:
    - postgres
    - elasticsearch
    - redis
    - worker
    - ingest-file
    tmpfs:
    - /tmp
    volumes:
    - archive-data:/data
    env_file:
    - ../aleph.env

  ui:
    image: malteos/aleph-ui-production:${ALEPH_TAG:-3.9.0}
    depends_on:
    - api
    ports:
    - "8080:8080"

  cwm:
    build:
     context: ../services/qurator_cwm
    image: malteos/cwm:${ALEPH_TAG:-latest}
    volumes:
    - archive-data:/data
    restart: on-failure
    env_file:
    - ../aleph.env

volumes:
  archive-data: {}
  postgres-data: {}
  redis-data: {}
  elasticsearch-data: {}
